# LQZC 商城抢券系统压测说明

## 一、项目概述

### 1.1 技术方案
设计并落地瓷砖商城大促优惠券限时抢领方案：
- **Redis 预扣券余量** - 库存缓存到Redis，避免数据库压力
- **Lua 脚本防超发** - 原子性操作，检查库存→检查限领→扣减库存
- **分布式锁初始化** - SETNX确保库存只初始化一次
- **发券流程异步化** - 领券记录异步写入数据库

### 1.2 核心代码

**Lua脚本** (`MallCouponController.java`):
```lua
local stock = tonumber(redis.call('get', KEYS[1]) or 0)
if stock <= 0 then
    return 0  -- 库存不足
end
local received = tonumber(redis.call('get', KEYS[2]) or 0)
local limit = tonumber(ARGV[1])
if received >= limit then
    return -1  -- 已达领取上限
end
redis.call('decr', KEYS[1])
redis.call('incr', KEYS[2])
return 1  -- 成功
```

**Redis Key设计**:
- `coupon:stock:{templateId}` - 库存余量
- `coupon:user:received:{templateId}:{customerId}` - 用户已领数量
- `coupon:init:lock:{templateId}` - 初始化分布式锁

---

## 二、测试环境

| 配置项 | 值 |
|--------|-----|
| 服务端口 | 8001 |
| 数据库 | MySQL 8.x (localhost:3306) |
| 缓存 | Redis 7.x (localhost:6379) |
| 测试工具 | JMeter 5.x |
| 运行环境 | 本地开发机（单机） |

---

## 三、测试准备

### 3.1 批量注册测试用户

```powershell
cd C:\Users\11965\IdeaProjects\lqzc\scripts
python batch_register.py
```

输出文件：
- `test_users.csv` - 包含 phone, token, customer_id

### 3.2 创建测试优惠券

```sql
INSERT INTO coupon_template (
  title, type, threshold_amount, discount_amount, 
  total_issued, per_user_limit, status, 
  valid_from, valid_to, create_time
) VALUES (
  '压测优惠券', 1, 0, 5.00, 
  1000, 1, 1, 
  '2024-01-01 00:00:00', '2025-12-31 23:59:59', NOW()
);

SELECT LAST_INSERT_ID();  -- 记录优惠券ID
```

### 3.3 清理环境（每次测试前）

```bash
# Redis清理
redis-cli DEL coupon:stock:{ID}
redis-cli KEYS "coupon:user:received:{ID}:*" | xargs redis-cli DEL
```

```sql
-- MySQL清理
DELETE FROM customer_coupon WHERE template_id = {ID};
```

### 3.4 JMeter配置

1. **CSV Data Set Config**: 加载 `test_users.csv`
2. **HTTP Header Manager**: `X-Customer-Token: ${token}`
3. **HTTP Request**: `POST /mall/coupon/receive/{templateId}`
4. **Thread Group**: 设置线程数和Ramp-Up时间

---

## 四、测试结果

### 4.1 2000并发/1秒（稳定）

| 测试轮次 | QPS | P95 | Error |
|----------|-----|-----|-------|
| 第1轮 | 919 | 160ms | 0% |
| 第2轮 | 893 | 222ms | 0% |
| 第3轮 | 800 | 152ms | 0% |
| **平均** | **~870** | **~178ms** | **0%** |

### 4.2 2100并发/1秒（极限）

| 测试轮次 | QPS | P95 | Error |
|----------|-----|-----|-------|
| 第1轮 | 1271 | 823ms | 0% |
| 第2轮 | **1345** | 812ms | 0% |
| 第3轮 | 1283 | 859ms | 0% |
| **平均** | **~1300** | **~830ms** | **0%** |

### 4.3 数据一致性验证

```sql
-- 验证无超发
SELECT 
  id, title, total_issued,
  (SELECT COUNT(*) FROM customer_coupon WHERE template_id = ct.id) as received,
  CASE 
    WHEN (SELECT COUNT(*) FROM customer_coupon WHERE template_id = ct.id) > total_issued 
    THEN '❌ 超发'
    ELSE '✅ 正常'
  END as status
FROM coupon_template ct
WHERE title LIKE '%压测%';
```

**结果**: 所有测试均**零超发** ✅

---

## 五、性能指标汇总

| 指标 | 2000/1秒 | 2100/1秒 |
|------|----------|----------|
| 瞬时并发 | 2000 | **2100** |
| 峰值QPS | ~870 | **~1300** |
| P95响应 | **~180ms** | ~830ms |
| 错误率 | 0% | 0% |
| 超发 | 无 | 无 |

**系统极限**: 单机可承受 **2100瞬时并发/秒**，超过此值会出现连接拒绝。

---

## 六、关键优化点

### 6.1 库存初始化优化
**问题**: 每次请求都检查 `hasKey()`，高并发下性能差

**优化**: 使用 `GET` 快速检查 + `SETNX` 分布式锁，确保只初始化一次

```java
// 先快速检查
String existingStock = stringRedisTemplate.opsForValue().get(stockKey);
if (existingStock != null) {
    return;  // 99.99%的请求直接返回
}

// SETNX获取锁，只有1个线程初始化
Boolean locked = stringRedisTemplate.opsForValue().setIfAbsent(lockKey, "1", 10, TimeUnit.SECONDS);
```

### 6.2 Lua脚本原子操作
确保"检查库存→检查限领→扣减库存"在一个原子操作中完成，避免并发问题。

---

## 七、简历描述

> **大促优惠券限时抢领方案**
>
> 设计并落地瓷砖商城大促优惠券限时抢领方案，采用 **Redis 预扣券余量 + Lua 脚本防超发**，并将发券流程异步化。经 JMeter 压测，系统在 **2100 瞬时并发（1秒内）、峰值 QPS 1300+** 场景下稳定运行，**错误率 0%**，成功保障活动期间**零超发、零资损**。

---

## 八、测试文件归档

```
scripts/
├── test_users.csv           # 测试用户数据
├── batch_register.py        # 用户注册脚本
├── 单机2000,1/              # 2000并发测试结果
│   ├── aggregate_1.csv
│   ├── aggregate_2.csv
│   └── aggregate_3.csv
└── 单机2100,1/              # 2100并发测试结果
    ├── aggregate_1.csv
    ├── aggregate_2.csv
    └── aggregate_3.csv
```

---

## 九、常见问题

### Q1: 出现 Connection refused
**原因**: 并发超过系统极限，Tomcat拒绝连接
**解决**: 降低Thread数或增加Ramp-Up时间

### Q2: Error%很高但系统没崩
**原因**: 大部分是业务错误（券抢光、已达上限）
**判断**: 查看错误详情，区分业务错误和系统错误

### Q3: 如何判断系统崩了
- 出现 `Connection refused`
- 后端进程退出
- 测试后无法访问 `http://localhost:8001/mall/coupon/market`

---

*文档生成时间: 2025年12月*

